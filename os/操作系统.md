# 进程与线程、协程

## 区别

进程：操作系统分配资源的基本单位

线程：调度的基本单位

协程：由程序员自己控制调度，运行与用户态

线程共享了进程的堆、地址空间、全局和静态变量，而线程之间方法栈、寄存器是私有的

进程之前的地址空间、堆栈完全独立

## 上下文切换

进程切换时会进行上下文切换，上下文包括三种

1. 用户级上下文：正文、数据、用户堆栈以及共享存储区；
2. 寄存器上下文：通用寄存器、程序寄存器(EIP)、处理器状态寄存器(EFLAGS)、栈指针(ESP)；
3. 系统级上下文：进程控制块task_struct、内存管理信息(mm_struct、vm_area_struct、pgd、pte)、内核栈。

进程切换需要保存所有三个上下文，而线程切换以及用户态和内核态切换只需要保存2。

而进程上下文切换需要CPU停下来保存这些信息，会有时间CPU损耗，同时进程切换也需要OS调度器的调度也会耗时，所以进程切换、系统调用会耗时，而线程需要保存的现场信息较少所以开销比进程切换小。

### 上下文信息保存在哪里

- 对于系统调用，CPU当前寄存器会被放在进程的内核栈，因为此时是进入了内核态，所以恢复时是从内核态恢复到用户态，直接从内核态恢复内核栈的数据到用户态。
- 对于线程间上下文切换，会将寄存器、栈指针存放在进程的PCB（进程控制块）中

### 线程挂掉是否会导致进程崩溃

会。因为线程共享了进程的地址空间，没有自己独立的地址空间，因此如果一个线程访问了非法内存地址会导致整个进程崩溃。