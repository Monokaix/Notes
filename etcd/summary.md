# 总结

- etcd一致性读用的是ReadIndex的算法，只有状态机的apply index大于等于commit index时才返回读数据，否则就等待，而commit index的正确性是通过每次都向leader请求保证的
- etcd通过ttl设置key时，会把当前节点时间加上ttl时间作为key的expiration，这个过期时间会被写到一个有序map。
  leader中会运行一个tick，每500ms触发一次，同时tick会产生一个sync消息，里面包含leader系统当前时间，leader把sync消息通过raft广播到所有节点，节点查询有序map，然后删除过期时间小于当前时间的key
- etcdctl的watch可分为一次和持续watch，可以加上参数指定从哪个版本号开始，当是持续watch时，etcd返回第一个大于等于watchindex的key的信息
- etcd支持cas操作，可以在put请求中设定key的条件(是否存在，值是否为指定值等)进行key的设置，只有在满足请求中的条件时才会进行set key操作
- 集群内全部节点都会记录修改存储状态的操作，如创建、删除、更新等操作，watch和get只会被本地节点记录
- etcd v3使用lease机制取代了v2的ttl机制
- 对目录的存储使用的是线段树结构，相当于把同一目录下的key看做是具有相同前缀的key处理